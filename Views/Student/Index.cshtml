@model StudentManagementSystem.Models.ViewModels.PagedStudentListVM
@{
    ViewBag.Title = "All Registered Students";
}

<h2>All Registered Students</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger">
        @ViewBag.ErrorMessage
    </div>
}

<div class="row" style="margin-bottom: 20px;">
    <div class="col-md-6">
        @using (Html.BeginForm("Index", "Student", FormMethod.Get, new { @class = "form-inline" }))
        {
            <div class="form-group d-flex align-items-center">
                <!-- Search Box + Button -->
                <div class="input-group" style="flex:1; max-width:500px;">
                    <input type="text" name="search" class="form-control" placeholder="Search by NRIC or Name" value="@Model.Search" />
                    <input type="hidden" name="page" value="1" />
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-primary ms-2">Search</button>
                    </div>
                </div>

                <!-- Optional Clear Link -->
                @if (!string.IsNullOrWhiteSpace(Model.Search))
                {
                    <a href="@Url.Action("Index", "Student", new { page = 1 })" class="btn btn-secondary ml-2">Clear</a>
                }
            </div>

        }
    </div>
    <div class="col-md-6 text-right">
        @Html.ActionLink("Register New Student", "Create", "Student", null, new { @class = "btn btn-success" })
    </div>
</div>

@if (Model != null && Model.Students != null && Model.Students.Any())
{
    <div class="row" style="margin-bottom: 10px;">
        <div class="col-md-6">
            <p class="text-muted">
                Showing @Model.StartRecord to @Model.EndRecord of @Model.TotalRecords entries
            </p>
        </div>
    </div>

    <table class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>S/N</th>
                <th>NRIC</th>
                <th>Name</th>
                <th>Gender</th>
                <th>Age</th>
                <th>No. Of Subjects</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Students)
            {
                <tr>
                    <td>@item.SerialNo</td>
                    <td>
                        @Html.ActionLink(item.NRIC, "Edit", "Student", new { nric = item.NRIC }, null)
                    </td>
                    <td>@item.Name</td>
                    <td>@item.Gender</td>
                    <td>@item.Age</td>
                    <td>@item.NoOfSubjects</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Pagination -->
    if (Model.TotalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination">
                if (Model.HasPreviousPage)
                {
                    <li>
                        @Html.ActionLink("«", "Index", "Student", new { page = 1, search = Model.Search }, new { @class = "page-link" })
                    </li>
                    <li>
                        @Html.ActionLink("‹", "Index", "Student", new { page = Model.CurrentPage - 1, search = Model.Search }, new { @class = "page-link" })
                    </li>
                }
                else
                {
                    <li class="disabled"><span class="page-link">«</span></li>
                    <li class="disabled"><span class="page-link">‹</span></li>
                }

                @{
                    int startPage = Math.Max(1, Model.CurrentPage - 2);
                    int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                }

                if (startPage > 1)
                {
                    <li>@Html.ActionLink("1", "Index", "Student", new { page = 1, search = Model.Search }, new { @class = "page-link" })</li>
                    if (startPage > 2)
                    {
                        <li class="disabled"><span class="page-link">...</span></li>
                    }
                }

                @for (int i = startPage; i <= endPage; i++)
                {
                    if (i == Model.CurrentPage)
                    {
                        <li class="active"><span class="page-link">@i</span></li>
                    }
                    else
                    {
                        <li>@Html.ActionLink(i.ToString(), "Index", "Student", new { page = i, search = Model.Search }, new { @class = "page-link" })</li>
                    }
                }

                if (endPage < Model.TotalPages)
                {
                    if (endPage < Model.TotalPages - 1)
                    {
                        <li class="disabled"><span class="page-link">...</span></li>
                    }
                    <li>@Html.ActionLink(Model.TotalPages.ToString(), "Index", "Student", new { page = Model.TotalPages, search = Model.Search }, new { @class = "page-link" })</li>
                }

                if (Model.HasNextPage)
                {
                    <li>
                        @Html.ActionLink("›", "Index", "Student", new { page = Model.CurrentPage + 1, search = Model.Search }, new { @class = "page-link" })
                    </li>
                    <li>
                        @Html.ActionLink("»", "Index", "Student", new { page = Model.TotalPages, search = Model.Search }, new { @class = "page-link" })
                    </li>
                }
                else
                {
                    <li class="disabled"><span class="page-link">›</span></li>
                    <li class="disabled"><span class="page-link">»</span></li>
                }
            </ul>
        </nav>
    }
}
else
{
    <div class="alert alert-info">
        @if (!string.IsNullOrWhiteSpace(Model.Search))
        {
            <p>No students found matching your search criteria.</p>
        }
        else
        {
            <p>No students registered yet. @Html.ActionLink("Register a new student", "Create", "Student")</p>
        }
    </div>
}
